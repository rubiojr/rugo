# RATS: smart-append linter tool
use "test"
use "os"

rats "linter detects verbose append"
  script = <<~SCRIPT
    arr = []
    arr = append(arr, 1)
    arr = append(arr, 2)
    puts(len(arr))
  SCRIPT
  test.write_file(test.tmpdir() + "/target.rugo", script)
  result = test.run("rugo run tools/linter/linter.rugo -- smart-append " + test.tmpdir() + "/target.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "arr = append(arr, 1)")
  test.assert_contains(result["output"], "suggestion: append arr, 1")
  test.assert_contains(result["output"], "2 issue(s) found.")
end

rats "linter ignores bare append"
  script = <<~SCRIPT
    arr = []
    append arr, 1
    append arr, 2
    puts(len(arr))
  SCRIPT
  test.write_file(test.tmpdir() + "/target.rugo", script)
  result = test.run("rugo run tools/linter/linter.rugo -- smart-append " + test.tmpdir() + "/target.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "No issues found.")
end

rats "linter ignores cross-variable append"
  script = <<~SCRIPT
    arr = []
    other = append(arr, 1)
    puts(len(other))
  SCRIPT
  test.write_file(test.tmpdir() + "/target.rugo", script)
  result = test.run("rugo run tools/linter/linter.rugo -- smart-append " + test.tmpdir() + "/target.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "No issues found.")
end

rats "linter detects inside def"
  script = <<~SCRIPT
    def collect(items)
      result = []
      for item in items
        result = append(result, item)
      end
      return result
    end
    puts(collect([1, 2, 3]))
  SCRIPT
  test.write_file(test.tmpdir() + "/target.rugo", script)
  result = test.run("rugo run tools/linter/linter.rugo -- smart-append " + test.tmpdir() + "/target.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "result = append(result, item)")
  test.assert_contains(result["output"], "suggestion: append result, item")
end

rats "linter fix rewrites verbose append"
  script = <<~SCRIPT
    arr = []
    arr = append(arr, 1)
    arr = append(arr, 2)
    puts(len(arr))
  SCRIPT
  target = test.tmpdir() + "/target.rugo"
  test.write_file(target, script)
  result = test.run("rugo run tools/linter/linter.rugo -- smart-append --fix " + target)
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "fixed:")
  test.assert_contains(result["output"], "2 issue(s) fixed.")

  # Verify fixed file runs correctly
  result2 = test.run("rugo run " + target)
  test.assert_eq(result2["status"], 0)
  test.assert_eq(result2["lines"][0], "2")
end

rats "linter fix is idempotent"
  script = <<~SCRIPT
    arr = []
    arr = append(arr, 1)
    puts(len(arr))
  SCRIPT
  target = test.tmpdir() + "/target.rugo"
  test.write_file(target, script)

  # First fix
  test.run("rugo run tools/linter/linter.rugo -- smart-append --fix " + target)

  # Second pass should find nothing
  result = test.run("rugo run tools/linter/linter.rugo -- smart-append " + target)
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "No issues found.")
end

rats "linter fix preserves indentation"
  script = <<~SCRIPT
    def foo()
      arr = []
      if true
        arr = append(arr, 1)
      end
      return arr
    end
    puts(foo()[0])
  SCRIPT
  target = test.tmpdir() + "/target.rugo"
  test.write_file(target, script)
  test.run("rugo run tools/linter/linter.rugo -- smart-append --fix " + target)

  # Verify fixed file still runs
  result = test.run("rugo run " + target)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["lines"][0], "1")
end

rats "linter handles multiple files"
  script1 = <<~SCRIPT
    a = []
    a = append(a, 1)
  SCRIPT
  script2 = <<~SCRIPT
    b = []
    b = append(b, 2)
  SCRIPT
  test.write_file(test.tmpdir() + "/a.rugo", script1)
  test.write_file(test.tmpdir() + "/b.rugo", script2)
  result = test.run("rugo run tools/linter/linter.rugo -- smart-append " + test.tmpdir() + "/a.rugo " + test.tmpdir() + "/b.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "2 issue(s) found.")
end

rats "linter no args shows usage"
  result = test.run("rugo run tools/linter/linter.rugo -- smart-append")
  test.assert_neq(result["status"], 0)
end

rats "linter detects inside for loop"
  script = <<~SCRIPT
    items = []
    for x in [1, 2, 3]
      items = append(items, x)
    end
    puts(len(items))
  SCRIPT
  test.write_file(test.tmpdir() + "/target.rugo", script)
  result = test.run("rugo run tools/linter/linter.rugo -- smart-append " + test.tmpdir() + "/target.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "items = append(items, x)")
  test.assert_contains(result["output"], "1 issue(s) found.")
end

rats "linter fix with complex value expression"
  script = <<~SCRIPT
    arr = []
    arr = append(arr, len([1, 2, 3]))
    puts(arr[0])
  SCRIPT
  target = test.tmpdir() + "/target.rugo"
  test.write_file(target, script)
  test.run("rugo run tools/linter/linter.rugo -- smart-append --fix " + target)

  result = test.run("rugo run " + target)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["lines"][0], "3")
end

rats "linter all command runs all linters"
  script = <<~SCRIPT
    arr = []
    arr = append(arr, 1)
    puts(len(arr))
  SCRIPT
  test.write_file(test.tmpdir() + "/target.rugo", script)
  result = test.run("rugo run tools/linter/linter.rugo -- all " + test.tmpdir() + "/target.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "[smart-append]")
  test.assert_contains(result["output"], "1 issue(s) found.")
end

rats "linter unknown command shows error"
  result = test.run("rugo run tools/linter/linter.rugo -- badcmd file.rugo")
  test.assert_neq(result["status"], 0)
end
