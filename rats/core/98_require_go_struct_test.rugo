# RATS: Test Go module struct support
# require can load Go modules with exported structs and bridge them
use "test"
use "conv"

rats "struct zero-value constructor and field set/get"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    c = sm.config()
    c.name = "myapp"
    c.port = 8080
    puts(c.name)
    puts(c.port)
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "myapp")
  test.assert_eq(lines[1], "8080")
end

rats "struct new_config constructor with args"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    c = sm.new_config("app", 3000)
    puts(c.name)
    puts(c.port)
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "app")
  test.assert_eq(lines[1], "3000")
end

rats "struct passed to Go function taking *Struct"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    c = sm.new_config("test", 9090)
    puts(sm.get_name(c))
    puts(sm.get_port(c))
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "test")
  test.assert_eq(lines[1], "9090")
end

rats "struct returned from Go function is wrapped"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    c = sm.new_config("orig", 80)
    c2 = sm.set_name(c, "updated")
    puts(c2.name)
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "updated")
end

rats "struct field modification via dot assign"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    c = sm.config()
    c.name = "before"
    c.name = "after"
    puts(c.name)
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "after")
end

rats "struct __type__ returns struct name"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    c = sm.config()
    puts(type_of(c))
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "Config")
end

rats "struct multiple types in same package"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    s = sm.new_server("localhost", 443)
    puts(sm.server_host(s))
    puts(sm.is_debug(s))
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "localhost")
  test.assert_eq(lines[1], "false")
end

rats "struct bool and float fields"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    s = sm.server()
    s.debug = true
    s.timeout = 30.5
    puts(s.debug)
    puts(s.timeout)
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "true")
  test.assert_eq(lines[1], "30.5")
end

rats "plain functions still work alongside structs"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    puts(sm.greet("world"))
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "Hello, world!")
end

rats "struct describe function uses struct fields"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    c = sm.new_config("production", 443)
    puts(sm.describe(c))
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "production config")
end
