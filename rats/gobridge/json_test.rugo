# RATS: Test Go bridge â€” encoding/json package
use "test"

import "encoding/json"

rats "json.marshal hash"
  result = json.marshal({name: "Rugo", version: 1})
  test.assert_contains(result, "\"name\"")
  test.assert_contains(result, "\"Rugo\"")
  test.assert_contains(result, "\"version\"")
end

rats "json.marshal string"
  test.assert_eq(json.marshal("hello"), "\"hello\"")
end

rats "json.marshal array"
  test.assert_eq(json.marshal([1, 2, 3]), "[1,2,3]")
end

rats "json.unmarshal object"
  parsed = json.unmarshal("{\"name\":\"Rugo\",\"version\":1}")
  test.assert_eq(parsed.name, "Rugo")
end

rats "json.unmarshal array"
  parsed = json.unmarshal("[1,2,3]")
  test.assert_eq(len(parsed), 3)
end

rats "json.unmarshal nested"
  parsed = json.unmarshal("{\"user\":{\"name\":\"Alice\"}}")
  test.assert_eq(parsed.user.name, "Alice")
end

rats "json round-trip"
  data = {greeting: "hello", count: 42}
  parsed = json.unmarshal(json.marshal(data))
  test.assert_eq(parsed.greeting, "hello")
end

# Subprocess: tests exit code on unhandled error
rats "json.unmarshal error"
  script = <<~SCRIPT
    import "encoding/json"
    json.unmarshal("not json")
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 1)
  test.assert_contains(result["output"], "json.unmarshal")
end

rats "json.marshal_indent"
  result = json.marshal_indent({name: "Rugo"}, "", "  ")
  test.assert_contains(result, "\"name\"")
  test.assert_contains(result, "\"Rugo\"")
end

rats "json.marshal nil"
  test.assert_eq(json.marshal(nil), "null")
end

rats "json.marshal boolean"
  test.assert_eq(json.marshal(true), "true")
  test.assert_eq(json.marshal(false), "false")
end

rats "json.unmarshal boolean and null"
  test.assert_eq(json.unmarshal("true"), true)
  test.assert_eq(json.unmarshal("false"), false)
  test.assert_nil(json.unmarshal("null"))
end

rats "json round-trip preserves integers"
  data = {count: 42}
  parsed = json.unmarshal(json.marshal(data))
  test.assert_eq(parsed.count + 1, 43.0)
end

rats "json.unmarshal deeply nested"
  parsed = json.unmarshal("{\"a\":{\"b\":{\"c\":\"deep\"}}}")
  test.assert_eq(parsed.a.b.c, "deep")
end

rats "json.marshal array of hashes"
  result = json.marshal([{name: "a"}, {name: "b"}])
  test.assert_contains(result, "\"name\"")
end

rats "json.unmarshal with try/or on bad input"
  result = try json.unmarshal("{{invalid") or "fallback"
  test.assert_eq(result, "fallback")
end
