// --- Rugo Spawn Runtime ---

type rugoTask struct {
	result interface{}
	err    string
	done   chan struct{}
}

// DotGet implements the field accessor interface for dot notation on tasks.
func (t *rugoTask) DotGet(field string) (interface{}, bool) {
	switch field {
	case "value":
		<-t.done
		if t.err != "" {
			panic(t.err)
		}
		return t.result, true
	case "done":
		select {
		case <-t.done:
			return true, true
		default:
			return false, true
		}
	}
	return nil, false
}

// DotCall implements the method call interface for task methods with arguments.
func (t *rugoTask) DotCall(method string, args ...interface{}) (interface{}, bool) {
	switch method {
	case "value":
		<-t.done
		if t.err != "" {
			panic(t.err)
		}
		return t.result, true
	case "done":
		select {
		case <-t.done:
			return true, true
		default:
			return false, true
		}
	case "wait":
		if len(args) < 1 {
			panic("task.wait requires a timeout in seconds")
		}
		secs := rugo_to_int(args[0])
		select {
		case <-t.done:
			if t.err != "" {
				panic(t.err)
			}
			return t.result, true
		case <-time.After(time.Duration(secs) * time.Second):
			panic(fmt.Sprintf("task timed out after %d seconds", secs))
		}
	}
	return nil, false
}

// --- End Rugo Spawn Runtime ---

