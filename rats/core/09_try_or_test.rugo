# RATS: Test try/or error handling
use "test"
use "eval"

rats "silent recovery returns nil on failure"
  source = <<~RUGO
    use "conv"
    result = try conv.to_i("bad")
    puts(result)
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "nil")
end

rats "default value on failure"
  source = <<~RUGO
    use "conv"
    result = try conv.to_i("bad") or 99
    puts(result)
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "99")
end

rats "handler block on failure"
  source = <<~RUGO
    use "conv"
    result = try conv.to_i("bad") or err
      puts("caught: " + err)
      42
    end
    puts(result)
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "caught:")
  test.assert_contains(result["output"], "42")
end

rats "passes through on success"
  source = <<~RUGO
    use "conv"
    result = try conv.to_i("42") or 0
    puts(result)
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "42")
end

rats "shell fallback with try"
  source = <<~RUGO
    try rm /tmp/rugo_nonexistent_file_xyz
    puts("continued")
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "continued")
end

rats "return inside try/or handler sets handler result"
  source = <<~RUGO
    def find_stuff(query)
      return [1, 2, 3]
    end

    def resolve(input)
      matches = try find_stuff(input) or err
        return nil
      end

      if len(matches) == 0
        return nil
      end

      return matches[0]
    end

    puts resolve("test")
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "1")
end

# Regression: try EXPR or VARIABLE (bare identifier as inline fallback)
# git-bug bbf7b30
rats "try or bare variable as fallback"
  source = <<~RUGO
    x = "fallback"
    wk = try raise("oops") or x
    puts(wk)
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "fallback")
end

rats "try or bare variable success path"
  source = <<~RUGO
    x = "fallback"
    wk = try "ok" or x
    puts(wk)
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "ok")
end

rats "try or block form still works"
  source = <<~RUGO
    result = try raise("boom") or err
      "caught: " + err
    end
    puts(result)
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "caught: boom")
end

# Regression: negative literal on own line in try/or handler block
# git-bug 7f2fe9b
rats "try or handler: negative literal as last expression"
  source = <<~RUGO
    use "conv"
    y = try conv.to_i("xyz") or err
      puts("caught: " + err)
      -1
    end
    puts(y)
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "caught:")
  test.assert_contains(result["output"], "-1")
end

rats "try or handler: negative float literal as last expression"
  source = <<~RUGO
    y = try raise("boom") or err
      puts("err: " + err)
      -3.14
    end
    puts(y)
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "-3.14")
end

rats "negative literal on own line outside try/or"
  source = <<~RUGO
    x = 10
    y = -1
    puts(x)
    puts(y)
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "10")
  test.assert_contains(result["output"], "-1")
end
