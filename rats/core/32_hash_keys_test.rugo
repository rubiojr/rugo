# RATS: Hash expression keys and iteration
# Tests for hash features that use non-string-literal keys
use "test"

# ============================================================
# A. Numeric Keys
# ============================================================

rats "hash with positive integer keys"
  h = {404 => "Not Found", 500 => "Server Error"}
  test.assert_eq(h[404], "Not Found")
  test.assert_eq(h[500], "Server Error")
end

rats "hash with mixed numeric and string keys"
  h = {1 => "one", "two" => 2}
  test.assert_eq(h[1], "one")
  test.assert_eq(h["two"], 2)
end

# ============================================================
# B. Variable / Computed Keys
# ============================================================

rats "hash with variable as key"
  result = test.run("rugo run rats/fixtures/hash_variable_key.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "Alice")
end

rats "hash with string interpolation key"
  result = test.run("rugo run rats/fixtures/hash_interpolation_key.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "Alice")
end

rats "building reverse mapping with variable keys"
  names = ["alice", "bob", "carol"]
  index = {}
  for i, name in names
    index[name] = i
  end
  test.assert_eq(index["alice"], 0)
  test.assert_eq(index["bob"], 1)
  test.assert_eq(index["carol"], 2)
end

# ============================================================
# C. Boolean and Nil Keys
# ============================================================

rats "hash with boolean keys"
  h = {true => "yes", false => "no"}
  test.assert_eq(h[true], "yes")
  test.assert_eq(h[false], "no")
end

rats "hash with nil key"
  h = {nil => "nothing"}
  test.assert_eq(h[nil], "nothing")
end

# ============================================================
# D. Hash Iteration (for k, v in hash)
# ============================================================

rats "for k, v in hash iterates all pairs"
  h = {"a" => 1, "b" => 2}
  keys = []
  vals = []
  for k, v in h
    keys = append(keys, k)
    vals = append(vals, v)
  end
  test.assert_eq(len(keys), 2)
  test.assert_eq(len(vals), 2)
end

rats "for single var in hash iterates keys"
  h = {"x" => 10, "y" => 20}
  keys = []
  for k in h
    keys = append(keys, k)
  end
  test.assert_eq(len(keys), 2)
  test.assert_eq(type_of(keys[0]), "String")
  test.assert_eq(type_of(keys[1]), "String")
end

# ============================================================
# E. Hash Bracket Assignment
# ============================================================

rats "hash bracket assignment sets value"
  h = {"x" => 1}
  h["x"] = 99
  test.assert_eq(h["x"], 99)
end

rats "hash bracket assignment adds new key"
  h = {}
  h["new"] = "value"
  test.assert_eq(h["new"], "value")
end

rats "incremental hash building in loop"
  words = ["hello", "world", "hello", "hello", "world"]
  counts = {}
  for word in words
    if counts[word]
      counts[word] += 1
    else
      counts[word] = 1
    end
  end
  test.assert_eq(counts["hello"], 3)
  test.assert_eq(counts["world"], 2)
end
