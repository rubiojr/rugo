# Tests for do...end trailing block syntax sugar.
# do...end is preprocessor sugar: `ident do ... end` â†’ `ident(fn() ... end)`

use "test"
use "eval"
use "str"

rats "do...end basic block"
  source = <<~'RUGO'
    def greet(name, block)
      puts "hello #{name}"
      block()
    end

    greet("world") do
      puts "inside block"
    end
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "hello world")
  test.assert_contains(result["output"], "inside block")
end

rats "do...end nested blocks"
  source = <<~'RUGO'
    def outer(block)
      puts "outer start"
      block()
      puts "outer end"
    end

    def inner(text, block)
      puts "inner: #{text}"
      block()
    end

    outer do
      inner("hello") do
        puts "deep"
      end
    end
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "outer start")
  test.assert_contains(result["output"], "inner: hello")
  test.assert_contains(result["output"], "deep")
  test.assert_contains(result["output"], "outer end")
end

rats "do...end with assignment"
  source = <<~RUGO
    def make(block)
      return block()
    end

    result = make do
      42
    end
    puts result
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "42")
end

rats "do...end paren-free with args"
  source = <<~'RUGO'
    def styled(text, block)
      puts "styled: #{text}"
      block()
    end

    styled "bold" do
      puts "content"
    end
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "styled: bold")
  test.assert_contains(result["output"], "content")
end

rats "do inside string is not treated as block"
  source = <<~RUGO
    # do inside a string should not be treated as a block
    puts "I do not want to do this"

    # function name ending in do-like suffix
    def redo_thing()
      puts "redo works"
    end
    redo_thing()
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "I do not want to do this")
  test.assert_contains(result["output"], "redo works")
end

rats "do...end with lambda inside body"
  source = <<~'RUGO'
    def box(block)
      puts "box start"
      block()
      puts "box end"
    end

    def item(text)
      puts "  #{text}"
    end

    # do block with lambda inside (fn with params)
    box do
      item("hello")
      callback = fn(x) puts "  cb: #{x}" end
      callback("world")
    end
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "box start")
  test.assert_contains(result["output"], "  hello")
  test.assert_contains(result["output"], "  cb: world")
  test.assert_contains(result["output"], "box end")
end

rats "unterminated do block gives error"
  source = <<~RUGO
    def foo(b)
      b()
    end

    foo do
      puts 1
  RUGO
  result = eval.run(source)
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "unterminated")
end
