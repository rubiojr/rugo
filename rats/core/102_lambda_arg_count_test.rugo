# RATS: Lambda argument count validation
# Bug: 23dcd84 â€” Lambdas silently ignore extra arguments
use "test"

rats "lambda with too many args errors"
  script = <<~SCRIPT
    f = fn(x) x * 2 end
    f(1, 2, 3)
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 1)
  test.assert_contains(result["output"], "1 argument")
  test.assert_contains(result["output"], "3 were given")
end

rats "lambda with too few args errors"
  script = <<~SCRIPT
    f = fn(x, y) x + y end
    f(1)
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 1)
  test.assert_contains(result["output"], "2 arguments")
  test.assert_contains(result["output"], "1 was given")
end

rats "lambda with zero args rejects args"
  script = <<~SCRIPT
    f = fn() 42 end
    f(1)
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 1)
  test.assert_contains(result["output"], "0 arguments")
  test.assert_contains(result["output"], "1 was given")
end

rats "lambda with correct arg count works"
  f = fn(x, y) x + y end
  test.assert_eq(f(3, 4), 7)
end

rats "lambda with zero params and zero args works"
  f = fn() 42 end
  test.assert_eq(f(), 42)
end

rats "lambda single arg works"
  double = fn(x) x * 2 end
  test.assert_eq(double(5), 10)
end

rats "lambda passed to .map still works"
  arr = [1, 2, 3]
  result = arr.map(fn(x) x * 10 end)
  test.assert_eq(result[0], 10)
  test.assert_eq(result[1], 20)
  test.assert_eq(result[2], 30)
end

rats "lambda passed to .filter still works"
  arr = [1, 2, 3, 4, 5]
  result = arr.filter(fn(x) x > 3 end)
  test.assert_eq(len(result), 2)
  test.assert_eq(result[0], 4)
  test.assert_eq(result[1], 5)
end

rats "lambda passed to .each still works"
  arr = [1, 2, 3]
  collected = []
  arr.each(fn(x) append collected, x end)
  test.assert_eq(len(collected), 3)
  test.assert_eq(collected[0], 1)
  test.assert_eq(collected[1], 2)
  test.assert_eq(collected[2], 3)
end

rats "lambda passed to .reduce still works"
  arr = [1, 2, 3, 4]
  sum = arr.reduce(0, fn(acc, x) acc + x end)
  test.assert_eq(sum, 10)
end

rats "lambda passed to hash .each still works"
  h = {a: 1, b: 2}
  keys = []
  h.each(fn(k, v) append keys, k end)
  test.assert_eq(len(keys), 2)
end
