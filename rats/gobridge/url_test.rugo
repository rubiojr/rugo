# RATS: Test Go bridge â€” net/url package
use "test"
use "eval"

import "net/url"

rats "url.parse full URL"
  u = url.parse("https://user@example.com:8080/path?q=hello#section")
  test.assert_eq(u.scheme, "https")
  test.assert_eq(u.host, "example.com:8080")
  test.assert_eq(u.hostname, "example.com")
  test.assert_eq(u.port, "8080")
  test.assert_eq(u.path, "/path")
  test.assert_eq(u.query, "q=hello")
  test.assert_eq(u.fragment, "section")
  test.assert_eq(u.user, "user")
end

rats "url.parse without port"
  u = url.parse("https://example.com/path")
  test.assert_eq(u.scheme, "https")
  test.assert_eq(u.hostname, "example.com")
  test.assert_eq(u.path, "/path")
end

rats "url.parse relative URL"
  u = url.parse("/api/v2/users?page=1")
  test.assert_eq(u.path, "/api/v2/users")
  test.assert_eq(u.query, "page=1")
end

rats "url.parse raw field"
  u = url.parse("https://example.com/path")
  test.assert_contains(u.raw, "https://example.com/path")
end

rats "url.query_escape and query_unescape"
  escaped = url.query_escape("hello world&foo=bar")
  test.assert_contains(escaped, "hello+world")
  test.assert_eq(url.query_unescape(escaped), "hello world&foo=bar")
end

rats "url.path_escape and path_unescape"
  escaped = url.path_escape("my/path segment")
  test.assert_eq(escaped, "my%2Fpath%20segment")
  test.assert_eq(url.path_unescape(escaped), "my/path segment")
end

# Subprocess: tests exit code on unhandled error
rats "url.query_unescape error"
  script = <<~SCRIPT
    import "net/url"
    url.query_unescape("%ZZ")
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 1)
  test.assert_contains(result["output"], "url.query_unescape")
end

rats "url.parse with alias"
  source = <<~RUGO
    import "net/url" as u
    parsed = u.parse("https://example.com:443/test")
    puts parsed.scheme
    puts parsed.hostname
    puts parsed.port
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "https")
  test.assert_contains(result["output"], "example.com")
  test.assert_contains(result["output"], "443")
end
