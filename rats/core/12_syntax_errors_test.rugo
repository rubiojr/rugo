# Tests for compile-time and runtime error messages.
# Ensures errors are clear, point to correct lines, and don't false-positive.

use "test"
use "str"

# --- Runtime type errors ---

rats "cannot index-assign to scalar"
  result = test.run("rugo run rats/fixtures/err_index_assign_scalar.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "cannot index-assign int")
end

rats "cannot index scalar"
  result = test.run("rugo run rats/fixtures/err_index_scalar.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "cannot index int")
end

rats "cannot subtract strings"
  result = test.run("rugo run rats/fixtures/err_string_subtract.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "cannot subtract string and string")
end

rats "cannot multiply string by int"
  result = test.run("rugo run rats/fixtures/err_string_multiply.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "cannot multiply string and int")
end

rats "cannot add nil and int"
  result = test.run("rugo run rats/fixtures/err_nil_add.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "cannot add")
end

rats "integer divide by zero"
  result = test.run("rugo run rats/fixtures/err_divide_by_zero.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "division by zero")
end

rats "integer modulo by zero"
  result = test.run("rugo run rats/fixtures/err_modulo_zero.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "division by zero")
end

# --- Builtin function errors ---

rats "len with no arguments"
  result = test.run("rugo run rats/fixtures/err_len_no_args.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "len requires one argument")
end

rats "len on non-indexable type"
  result = test.run("rugo run rats/fixtures/err_len_scalar.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "cannot get length of int")
end

rats "append on non-array"
  result = test.run("rugo run rats/fixtures/err_append_non_array.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "first argument to append must be an array")
end

# --- Compile-time errors ---

rats "unknown stdlib module"
  result = test.run("rugo run rats/fixtures/err_unknown_module.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "unknown module")
end

rats "missing end keyword"
  result = test.run("rugo run rats/fixtures/err_missing_end.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "error:")
end

rats "mismatched bracket"
  result = test.run("rugo run rats/fixtures/err_mismatched_bracket.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "error:")
end

# --- Orphan or detection ---

rats "orphan or without try produces error"
  result = test.run("rugo run rats/fixtures/err_orphan_or.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "or")
  test.assert_contains(result["output"], "try")
end

rats "or inside string literal is not flagged"
  result = test.run("rugo run rats/fixtures/ok_or_in_string.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "hello or world")
end

rats "or as part of a word is not flagged"
  result = test.run("rugo run rats/fixtures/ok_or_in_word.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "ordering")
end

# --- Error output format ---

rats "runtime errors have no Go stacktrace"
  result = test.run("rugo run rats/fixtures/err_divide_by_zero.rugo")
  test.assert_neq(result["status"], 0)
  lines = result["lines"]
  for line in lines
    test.assert_false(str.contains(line, "goroutine"))
    test.assert_false(str.contains(line, "main.go"))
  end
end

rats "runtime errors show .rugo filename and line"
  result = test.run("rugo run rats/fixtures/err_divide_by_zero.rugo")
  test.assert_contains(result["output"], "err_divide_by_zero.rugo:1")
end

# --- Unterminated literals ---

rats "unclosed backtick produces clear error"
  result = test.run("rugo run rats/fixtures/err_unclosed_backtick.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "unterminated backtick")
end

rats "unclosed string produces clear error"
  result = test.run("rugo run rats/fixtures/err_unclosed_string.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "unterminated string")
end
