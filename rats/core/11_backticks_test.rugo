use "test"
use "eval"
use "str"

rats "backtick captures command output"
  source = <<~RUGO
    name = `whoami`
    puts name
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  expected = str.trim(`whoami`)
  test.assert_contains(result["output"], expected)
end

rats "backtick works with pipes"
  source = <<~RUGO
    count = `printf hello | wc -c | tr -d ' '`
    puts count
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "5")
end

rats "backtick with try/or for error handling"
  source = <<~RUGO
    result = try `cat /nonexistent_file_xyz` or "fallback"
    puts result
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "fallback")
end

rats "backtick result in expressions"
  source = <<~RUGO
    a = `echo hello`
    b = `echo world`
    puts a + " " + b
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "hello world")
end

rats "backtick with string interpolation"
  source = <<~'RUGO'
    name = "world"
    result = `echo hello #{name}`
    puts result

    greeting = "hi"
    who = "rugo"
    result2 = `echo #{greeting} #{who}`
    puts result2

    x = 21
    result3 = `echo #{x * 2}`
    puts result3

    # Integer variable
    port = 8080
    puts `echo #{port}`

    # Interpolation at start of command
    cmd = "echo"
    puts `#{cmd} started`

    # Adjacent interpolations
    a = "foo"
    b = "bar"
    puts `echo #{a}#{b}`
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "hello world")
  test.assert_eq(lines[1], "hi rugo")
  test.assert_eq(lines[2], "42")
  test.assert_eq(lines[3], "8080")
  test.assert_eq(lines[4], "started")
  test.assert_eq(lines[5], "foobar")
end

rats "backtick interpolation in different scopes"
  source = <<~'RUGO'
    def greet(name)
      return `echo hello #{name}`
    end
    puts greet("rugo")

    prefix = "hi"
    greeter = fn(name)
      return `echo #{prefix} #{name}`
    end
    puts greeter("world")

    names = ["alice", "bob"]
    for name in names
      puts `echo hey #{name}`
    end

    flag = true
    if flag
      puts `echo flag #{flag}`
    end
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "hello rugo")
  test.assert_eq(lines[1], "hi world")
  test.assert_eq(lines[2], "hey alice")
  test.assert_eq(lines[3], "hey bob")
  test.assert_eq(lines[4], "flag true")
end

rats "backtick interpolation with pipe"
  source = <<~'RUGO'
    use "str"
    name = "world"
    result = `echo hello #{name}` | str.upper
    puts result
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "HELLO WORLD")
end

rats "backtick interpolation with nested quotes gives friendly error"
  source = <<~'RUGO'
    person = {"name" => "alice"}
    puts `echo #{person["name"]}`
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 1)
  test.assert_contains(result["output"], "nested double quotes inside backtick interpolation")
end
