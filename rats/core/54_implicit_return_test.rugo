# RATS: Test implicit return (last expression in function body)
use "test"
use "eval"

rats "implicit return with literal"
  source = <<~RUGO
    def answer
      42
    end
    puts(answer())
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "42")
end

rats "implicit return with variable"
  source = <<~RUGO
    def greet(name)
      msg = "hello " + name
      msg
    end
    puts(greet("world"))
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "hello world")
end

rats "implicit return with array index"
  source = <<~RUGO
    def last(arr)
      arr[-1]
    end
    puts(last([1, 2, 3]))
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "3")
end

rats "implicit return with function call"
  source = <<~RUGO
    use "str"
    def first_word(s)
      parts = str.split(s, " ")
      parts[0]
    end
    puts(first_word("hello world"))
  RUGO
  test.write_file("#{test.tmpdir()}/test.rugo", source)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "hello")
end

rats "implicit return with arithmetic"
  source = <<~RUGO
    def double(x)
      x * 2
    end
    puts(double(21))
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "42")
end

rats "explicit return still works"
  source = <<~RUGO
    def early(x)
      if x > 10
        return "big"
      end
      "small"
    end
    puts(early(5))
    puts(early(20))
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "small\nbig")
end
