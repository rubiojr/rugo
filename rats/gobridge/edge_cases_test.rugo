# RATS: Test Go bridge â€” error handling and edge cases
use "test"

rats "import conflict with use errors"
  script = <<~SCRIPT
    use "os"
    import "os"
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "conflicts")
end

rats "import with alias resolves conflict"
  script = <<~SCRIPT
    use "os"
    import "os" as go_os
    home = go_os.getenv("HOME")
    puts("bridge:" + home)
    r = os.exec("echo from_rugo_os")
    puts("rugo:" + r)
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "bridge:")
end

rats "unknown Go bridge package errors"
  script = <<~SCRIPT
    import "net/http"
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "unknown package")
end

rats "unknown function in Go bridge errors"
  script = <<~SCRIPT
    import "strings"
    strings.nonexistent("hello")
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "unknown function")
end

rats "wrong arg count for Go bridge errors"
  script = <<~SCRIPT
    import "strings"
    strings.contains("hello")
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "takes")
  test.assert_contains(result["output"], "given")
end

rats "multiple Go bridge packages in one script"
  script = <<~SCRIPT
    import "strings"
    import "strconv"
    import "math"
    use "conv"
    puts(strings.to_upper("hello"))
    puts(strconv.itoa(42))
    puts(conv.to_s(math.sqrt(9.0)))
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "HELLO")
  test.assert_contains(result["output"], "42")
  test.assert_contains(result["output"], "3")
end

rats "Go bridge works with user modules"
  script = <<~SCRIPT
    import "strings"
    def greet(name)
      return strings.to_upper("hello " + name)
    end
    puts(greet("world"))
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "HELLO WORLD")
end

rats "Go bridge in required file"
  helper = <<~SCRIPT
    import "strings"
    def shout(s)
      return strings.to_upper(s)
    end
  SCRIPT
  test.write_file(test.tmpdir() + "/helper.rugo", helper)

  main = <<~SCRIPT
    require "helper"
    puts(helper.shout("hello"))
  SCRIPT
  test.write_file(test.tmpdir() + "/main.rugo", main)

  result = test.run("rugo run " + test.tmpdir() + "/main.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "HELLO")
end
