# RATS: Hash expression keys and iteration
# Tests for hash features that use non-string-literal keys
use "test"

# ============================================================
# A. Numeric Keys
# ============================================================

rats "hash with positive integer keys"
  script = <<~SCRIPT
    h = {404 => "Not Found", 500 => "Server Error"}
    puts(h[404])
    puts(h[500])
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "Not Found")
  test.assert_eq(lines[1], "Server Error")
end

rats "hash with mixed numeric and string keys"
  script = <<~SCRIPT
    h = {1 => "one", "two" => 2}
    puts(h[1])
    puts(h["two"])
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "one")
  test.assert_eq(lines[1], "2")
end

# ============================================================
# B. Variable / Computed Keys
# ============================================================

rats "hash with variable as key"
  result = test.run("rugo run rats/fixtures/hash_variable_key.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "Alice")
end

rats "hash with string interpolation key"
  result = test.run("rugo run rats/fixtures/hash_interpolation_key.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "Alice")
end

rats "building reverse mapping with variable keys"
  script = <<~SCRIPT
    names = ["alice", "bob", "carol"]
    index = {}
    for i, name in names
      index[name] = i
    end
    puts(index["alice"])
    puts(index["bob"])
    puts(index["carol"])
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "0")
  test.assert_eq(lines[1], "1")
  test.assert_eq(lines[2], "2")
end

# ============================================================
# C. Boolean and Nil Keys
# ============================================================

rats "hash with boolean keys"
  script = <<~SCRIPT
    h = {true => "yes", false => "no"}
    puts(h[true])
    puts(h[false])
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "yes")
  test.assert_eq(lines[1], "no")
end

rats "hash with nil key"
  script = <<~SCRIPT
    h = {nil => "nothing"}
    puts(h[nil])
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "nothing")
end

# ============================================================
# D. Hash Iteration (for k, v in hash)
# ============================================================

rats "for k, v in hash iterates all pairs"
  script = <<~SCRIPT
    h = {"a" => 1, "b" => 2}
    keys = []
    vals = []
    for k, v in h
      keys = append(keys, k)
      vals = append(vals, v)
    end
    puts(len(keys))
    puts(len(vals))
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "2")
  test.assert_eq(lines[1], "2")
end

rats "for single var in hash iterates keys"
  script = <<~SCRIPT
    h = {"x" => 10, "y" => 20}
    count = 0
    for k in h
      count += 1
    end
    puts(count)
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "2")
end

# ============================================================
# E. Hash Bracket Assignment
# ============================================================

rats "hash bracket assignment sets value"
  script = <<~SCRIPT
    h = {"x" => 1}
    h["x"] = 99
    puts(h["x"])
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "99")
end

rats "hash bracket assignment adds new key"
  script = <<~SCRIPT
    h = {}
    h["new"] = "value"
    puts(h["new"])
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "value")
end

rats "incremental hash building in loop"
  script = <<~SCRIPT
    words = ["hello", "world", "hello", "hello", "world"]
    counts = {}
    for word in words
      if counts[word]
        counts[word] += 1
      else
        counts[word] = 1
      end
    end
    puts(counts["hello"])
    puts(counts["world"])
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "3")
  test.assert_eq(lines[1], "2")
end
