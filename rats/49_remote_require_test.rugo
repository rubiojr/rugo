# RATS: Test remote require from git repositories
#
# Starts an in-process git server using web.static + spawn web.listen(0),
# then verifies that require "localhost:PORT/user/repo@version" fetches,
# caches, and compiles remote .rugo modules correctly.
use "test"
use "web"
use "conv"
use "str"

# --- File-level setup: bare git repo + in-process server ---

def setup_file()
  r = test.run("mkdir -p /tmp/rats_remote_require/repos/testuser/rugo-test-mod.git /tmp/rats_remote_require/work")
  if r["status"] != 0
    puts "DEBUG setup mkdir: " + r["output"]
  end
  r = test.run("git init --bare /tmp/rats_remote_require/repos/testuser/rugo-test-mod.git")
  if r["status"] != 0
    puts "DEBUG setup git init: " + r["output"]
  end
  r = test.run("git clone /tmp/rats_remote_require/repos/testuser/rugo-test-mod.git /tmp/rats_remote_require/work")
  if r["status"] != 0
    puts "DEBUG setup git clone: " + r["output"]
  end

  mod_src = <<~RG
    def greet(name)
      return "Hello from remote, " + name + "!"
    end

    def double(n)
      return n * 2
    end
  RG
  test.write_file("/tmp/rats_remote_require/work/rugo-test-mod.rugo", mod_src)

  r = test.run("cd /tmp/rats_remote_require/work && git config user.email test@test.com && git config user.name test && git add . && git commit -m initial && git tag v0.1.0")
  if r["status"] != 0
    puts "DEBUG setup git commit: " + r["output"]
  end
  r = test.run("cd /tmp/rats_remote_require/work && git push origin HEAD v0.1.0")
  if r["status"] != 0
    puts "DEBUG setup git push: " + r["output"]
  end
  r = test.run("cd /tmp/rats_remote_require/repos/testuser/rugo-test-mod.git && git update-server-info")
  if r["status"] != 0
    puts "DEBUG setup update-server-info: " + r["output"]
  end

  web.static("/testuser/rugo-test-mod.git", "/tmp/rats_remote_require/repos/testuser/rugo-test-mod.git")
  spawn web.listen(0)
  p = web.port()
  test.write_file("/tmp/rats_remote_require/port", conv.to_s(p))
  puts "DEBUG setup complete, port=" + conv.to_s(p)
end

def teardown_file()
  test.run("rm -rf /tmp/rats_remote_require")
end

# --- Tests ---

rats "remote require loads functions from git repo"
  tmpdir = test.tmpdir()
  port = test.run("cat /tmp/rats_remote_require/port")["output"]
  consumer = <<~RG
    use "conv"
    require "localhost:PORT/testuser/rugo-test-mod@v0.1.0" as "mod"
    puts(mod.greet("Rugo"))
    puts(conv.to_s(mod.double(21)))
  RG
  consumer = str.replace(consumer, "PORT", port)
  test.write_file(tmpdir + "/consumer.rugo", consumer)
  result = test.run("RUGO_MODULE_DIR=" + tmpdir + "/modules rugo run " + tmpdir + "/consumer.rugo")
  if result["status"] != 0
    puts "DEBUG test1 port=" + port + " status=" + conv.to_s(result["status"])
    puts "DEBUG test1 output: " + result["output"]
  end
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "Hello from remote, Rugo!")
  test.assert_eq(lines[1], "42")
end

rats "remote require uses default namespace from repo name"
  tmpdir = test.tmpdir()
  port = test.run("cat /tmp/rats_remote_require/port")["output"]
  consumer = <<~RG
    require "localhost:PORT/testuser/rugo-test-mod@v0.1.0"
    puts(rugo_test_mod.greet("world"))
  RG
  consumer = str.replace(consumer, "PORT", port)
  test.write_file(tmpdir + "/consumer.rugo", consumer)
  result = test.run("RUGO_MODULE_DIR=" + tmpdir + "/modules rugo run " + tmpdir + "/consumer.rugo")
  if result["status"] != 0
    puts "DEBUG test2 output: " + result["output"]
  end
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "Hello from remote, world!")
end

rats "remote require caches immutable versions"
  tmpdir = test.tmpdir()
  moddir = tmpdir + "/modules"
  port = test.run("cat /tmp/rats_remote_require/port")["output"]
  consumer = <<~RG
    require "localhost:PORT/testuser/rugo-test-mod@v0.1.0" as "mod"
    puts(mod.greet("cache"))
  RG
  consumer = str.replace(consumer, "PORT", port)
  test.write_file(tmpdir + "/consumer.rugo", consumer)

  # First run: fetches from server
  result = test.run("RUGO_MODULE_DIR=" + moddir + " rugo run " + tmpdir + "/consumer.rugo")
  if result["status"] != 0
    puts "DEBUG test3 run1 output: " + result["output"]
  end
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "Hello from remote, cache!")

  # Verify cache dir was created
  cache_path = moddir + "/localhost:" + port + "/testuser/rugo-test-mod/v0.1.0"
  result = test.run("test -d " + cache_path)
  test.assert_eq(result["status"], 0)

  # Second run: uses cache (immutable version, compiler skips fetch)
  result = test.run("RUGO_MODULE_DIR=" + moddir + " rugo run " + tmpdir + "/consumer.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "Hello from remote, cache!")
end

rats "remote require fails gracefully on bad repo"
  tmpdir = test.tmpdir()
  port = test.run("cat /tmp/rats_remote_require/port")["output"]
  consumer = <<~RG
    require "localhost:PORT/nobody/nonexistent@v1.0.0" as "bad"
    puts(bad.foo())
  RG
  consumer = str.replace(consumer, "PORT", port)
  test.write_file(tmpdir + "/consumer.rugo", consumer)
  result = test.run("RUGO_MODULE_DIR=" + tmpdir + "/modules rugo run " + tmpdir + "/consumer.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "git clone")
end

rats "remote require with build produces working binary"
  tmpdir = test.tmpdir()
  port = test.run("cat /tmp/rats_remote_require/port")["output"]
  consumer = <<~RG
    use "conv"
    require "localhost:PORT/testuser/rugo-test-mod@v0.1.0" as "mod"
    puts(mod.greet("binary"))
    puts(conv.to_s(mod.double(5)))
  RG
  consumer = str.replace(consumer, "PORT", port)
  test.write_file(tmpdir + "/consumer.rugo", consumer)
  build_result = test.run("RUGO_MODULE_DIR=" + tmpdir + "/modules rugo build " + tmpdir + "/consumer.rugo -o " + tmpdir + "/consumer_bin")
  if build_result["status"] != 0
    puts "DEBUG test5 build output: " + build_result["output"]
  end
  result = test.run(tmpdir + "/consumer_bin")
  if result["status"] != 0
    puts "DEBUG test5 run output: " + result["output"]
  end
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "Hello from remote, binary!")
  test.assert_eq(lines[1], "10")
end
