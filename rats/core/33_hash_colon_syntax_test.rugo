# RATS: Hash colon syntax (ident: value shorthand)
use "test"
use "eval"

# ============================================================
# A. Basic Colon Syntax
# ============================================================

rats "colon syntax with string value"
  h = {name: "Alice"}
  test.assert_eq(h["name"], "Alice")
end

rats "colon syntax with integer value"
  h = {age: 30}
  test.assert_eq(h["age"], 30)
end

rats "colon syntax multiple keys"
  h = {name: "Alice", age: 30, city: "NYC"}
  test.assert_eq(h["name"], "Alice")
  test.assert_eq(h["age"], 30)
  test.assert_eq(h["city"], "NYC")
end

rats "colon syntax with dot access"
  h = {name: "Alice", age: 30}
  test.assert_eq(h.name, "Alice")
  test.assert_eq(h.age, 30)
end

rats "colon syntax with boolean value"
  h = {enabled: true, debug: false}
  test.assert_eq(h.enabled, true)
  test.assert_eq(h.debug, false)
end

rats "colon syntax with nil value"
  h = {val: nil}
  test.assert_eq(h.val == nil, true)
end

# ============================================================
# B. Mixed Colon and Arrow Syntax
# ============================================================

rats "mixed colon and arrow keys"
  h = {name: "Alice", "age" => 30}
  test.assert_eq(h.name, "Alice")
  test.assert_eq(h.age, 30)
end

rats "arrow syntax still works unchanged"
  h = {"a" => 1, "b" => 2}
  test.assert_eq(h["a"], 1)
  test.assert_eq(h["b"], 2)
end

# ============================================================
# C. Colon Syntax in Nested Contexts
# ============================================================

rats "nested colon hashes"
  h = {user: {name: "Alice", email: "alice@test.com"}}
  test.assert_eq(h.user.name, "Alice")
  test.assert_eq(h.user.email, "alice@test.com")
end

rats "colon hash in array"
  items = [{name: "a"}, {name: "b"}]
  test.assert_eq(items[0].name, "a")
  test.assert_eq(items[1].name, "b")
end

rats "colon hash returned from function"
  source = <<~RUGO
    def make()
      return {name: "Alice", age: 30}
    end
    h = make()
    puts(h.name)
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "Alice")
end

rats "colon syntax with underscore key"
  h = {first_name: "Alice", last_name: "Smith"}
  test.assert_eq(h.first_name, "Alice")
  test.assert_eq(h.last_name, "Smith")
end

# ============================================================
# D. Colon Syntax in Expressions
# ============================================================

rats "colon hash in if condition"
  config = {enabled: true}
  result = "no"
  if config.enabled
    result = "yes"
  end
  test.assert_eq(result, "yes")
end

rats "colon hash with for iteration"
  h = {x: 10, y: 20}
  total = 0
  for k, v in h
    total += v
  end
  test.assert_eq(total, 30)
end

rats "colon hash with dot-set"
  h = {count: 0}
  h.count = 42
  test.assert_eq(h.count, 42)
end

rats "colon hash compiles to native binary"
  script = <<~SCRIPT
    h = {name: "Alice", age: 30}
    puts(h.name)
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo build -o #{test.tmpdir()}/test #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 0)
  result = test.run("#{test.tmpdir()}/test")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "Alice")
end

# ============================================================
# E. Integer Colon Keys Rejected
# ============================================================

rats "integer colon key produces clear error"
  script = <<~SCRIPT
    h = {1: "one", 2: "two"}
    puts h[1]
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "arrow syntax")
  test.assert_contains(result["output"], "1 =>")
end
