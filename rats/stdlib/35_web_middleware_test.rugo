# RATS: Test web module built-in middleware (real_ip, rate_limiter)
use "test"
use "json"
use "web"

# --- real_ip middleware ---

rats "real_ip strips port from remote_addr"
  result = test.run("rugo run rats/fixtures/web_real_ip_basic.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "::1")
end

rats "real_ip resolves X-Forwarded-For header"
  p = web.free_port()
  script = <<~SCRIPT
    use "web"
    use "http"
    web.middleware("real_ip")
    web.get("/ip", "ip_handler")
    def ip_handler(req)
      return web.text(req.remote_addr)
    end
    spawn web.listen(#{p})
    web.port()
    puts(http.get("http://localhost:#{p}/ip").body)
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 0)
  # Without X-Forwarded-For, falls back to stripping port
  test.assert_eq(result["output"], "::1")
end

rats "real_ip works before logger"
  result = test.run("rugo run rats/fixtures/web_real_ip_logger.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "::1")
end

rats "real_ip without headers strips port"
  p = web.free_port()
  script = <<~SCRIPT
    use "web"
    use "http"
    web.middleware("real_ip")
    web.get("/check", "check_handler")
    def check_handler(req)
      return web.text(req.remote_addr)
    end
    spawn web.listen(#{p})
    web.port()
    r = http.get("http://localhost:#{p}/check").body
    puts(r)
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 0)
  # Should be bare IP (port stripped)
  test.assert_eq(result["output"], "::1")
end

rats "real_ip does not interfere with handler"
  p = web.free_port()
  script = <<~SCRIPT
    use "web"
    use "http"
    web.middleware("real_ip")
    web.get("/data", "data_handler")
    def data_handler(req)
      return web.json({"ip" => req.remote_addr, "method" => req.method})
    end
    spawn web.listen(#{p})
    web.port()
    puts(http.get("http://localhost:#{p}/data").body)
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "\"ip\":\"::1\"")
  test.assert_contains(result["output"], "\"method\":\"GET\"")
end

# --- rate_limiter middleware ---

rats "rate_limiter blocks after burst"
  result = test.run("rugo run rats/fixtures/web_rate_limit.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "pong")
  test.assert_eq(lines[1], "pong")
  test.assert_contains(lines[2], "rate limit exceeded")
end

rats "rate_limiter recovers after waiting"
  result = test.run("rugo run rats/fixtures/web_rate_limit_recover.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "pong")
  test.assert_eq(lines[1], "pong")
  test.assert_contains(lines[2], "rate limit exceeded")
  test.assert_eq(lines[3], "pong")
end

rats "rate_limiter default 10 rps without config"
  result = test.run("rugo run rats/fixtures/web_rate_limit_default.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "pong")
  test.assert_eq(lines[1], "pong")
  test.assert_eq(lines[2], "pong")
end

rats "rate_limiter returns 429 JSON error"
  p = web.free_port()
  script = <<~SCRIPT
    use "web"
    use "http"
    use "json"
    web.rate_limit(1)
    web.middleware("rate_limiter")
    web.get("/api", "api_handler")
    def api_handler(req)
      return web.text("ok")
    end
    spawn web.listen(#{p})
    web.port()
    puts(http.get("http://localhost:#{p}/api").body)
    puts(http.get("http://localhost:#{p}/api").body)
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "ok")
  parsed = json.parse(lines[1])
  test.assert_eq(parsed["error"], "rate limit exceeded")
end

rats "rate_limiter with route-level middleware"
  p = web.free_port()
  script = <<~SCRIPT
    use "web"
    use "http"
    web.rate_limit(1)
    web.get("/free", "free_handler")
    web.get("/limited", "limited_handler", "rate_limiter")
    def free_handler(req)
      return web.text("free")
    end
    def limited_handler(req)
      return web.text("limited")
    end
    spawn web.listen(#{p})
    web.port()
    puts(http.get("http://localhost:#{p}/limited").body)
    puts(http.get("http://localhost:#{p}/limited").body)
    puts(http.get("http://localhost:#{p}/free").body)
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "limited")
  test.assert_contains(lines[1], "rate limit exceeded")
  # free endpoint not affected
  test.assert_eq(lines[2], "free")
end

rats "rate_limiter with float rps"
  p = web.free_port()
  script = <<~SCRIPT
    use "web"
    use "http"
    web.rate_limit(0.5)
    web.middleware("rate_limiter")
    web.get("/slow", "slow_handler")
    def slow_handler(req)
      return web.text("ok")
    end
    spawn web.listen(#{p})
    web.port()
    puts(http.get("http://localhost:#{p}/slow").body)
    puts(http.get("http://localhost:#{p}/slow").body)
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "ok")
  test.assert_contains(lines[1], "rate limit exceeded")
end

# --- combined middleware ---

rats "real_ip + rate_limiter work together"
  p = web.free_port()
  script = <<~SCRIPT
    use "web"
    use "http"
    web.rate_limit(2)
    web.middleware("real_ip")
    web.middleware("rate_limiter")
    web.get("/combo", "combo_handler")
    def combo_handler(req)
      return web.text("ip:" + req.remote_addr)
    end
    spawn web.listen(#{p})
    web.port()
    puts(http.get("http://localhost:#{p}/combo").body)
    puts(http.get("http://localhost:#{p}/combo").body)
    puts(http.get("http://localhost:#{p}/combo").body)
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "ip:::1")
  test.assert_eq(lines[1], "ip:::1")
  test.assert_contains(lines[2], "rate limit exceeded")
end

rats "real_ip + logger + rate_limiter full stack"
  p = web.free_port()
  script = <<~SCRIPT
    use "web"
    use "http"
    web.rate_limit(5)
    web.middleware("real_ip")
    web.middleware("logger")
    web.middleware("rate_limiter")
    web.get("/stack", "stack_handler")
    def stack_handler(req)
      return web.json({"ok" => true})
    end
    spawn web.listen(#{p})
    web.port()
    puts(http.get("http://localhost:#{p}/stack").body)
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "\"ok\":true")
end

rats "rate_limiter compiles to native binary"
  script = <<~SCRIPT
    use "web"
    web.rate_limit(10)
    web.middleware("rate_limiter")
    web.get("/", "home")
    def home(req)
      return web.text("ok")
    end
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo build #{test.tmpdir()}/test.rugo -o #{test.tmpdir()}/mwbin")
  test.assert_eq(result["status"], 0)
  test.run("rm -f #{test.tmpdir()}/mwbin")
end

rats "real_ip compiles to native binary"
  script = <<~SCRIPT
    use "web"
    web.middleware("real_ip")
    web.get("/", "home")
    def home(req)
      return web.text("ok")
    end
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo build #{test.tmpdir()}/test.rugo -o #{test.tmpdir()}/ipbin")
  test.assert_eq(result["status"], 0)
  test.run("rm -f #{test.tmpdir()}/ipbin")
end

rats "rate_limit config appears in emitted code"
  script = <<~SCRIPT
    use "web"
    web.rate_limit(100)
    web.middleware("rate_limiter")
    web.get("/", "home")
    def home(req)
      return web.text("ok")
    end
    web.listen(9999)
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo emit #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "rugo_web_rate_limit")
  test.assert_contains(result["output"], "tokenBucketLimiter")
end
