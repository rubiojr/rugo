# RATS: Built-in array collection methods
# Tests for .map, .filter, .reject, .each, .reduce, .find, .any, .all,
# .count, .join, .first, .last, .min, .max, .sum, .flatten, .uniq,
# .sort_by, .flat_map, .take, .drop, .zip, .chunk
use "test"

# ============================================================
# A. map
# ============================================================

rats "array.map transforms each element"
  nums = [1, 2, 3]
  result = nums.map(fn(x) x * 2 end)
  test.assert_eq(result[0], 2)
  test.assert_eq(result[1], 4)
  test.assert_eq(result[2], 6)
end

rats "array.map on empty array returns empty"
  result = [].map(fn(x) x * 2 end)
  test.assert_eq(len(result), 0)
end

# ============================================================
# B. filter
# ============================================================

rats "array.filter keeps matching elements"
  nums = [1, 2, 3, 4, 5]
  result = nums.filter(fn(x) x > 3 end)
  test.assert_eq(len(result), 2)
  test.assert_eq(result[0], 4)
  test.assert_eq(result[1], 5)
end

rats "array.filter on empty array returns empty"
  result = [].filter(fn(x) x > 0 end)
  test.assert_eq(len(result), 0)
end

# ============================================================
# C. reject
# ============================================================

rats "array.reject removes matching elements"
  nums = [1, 2, 3, 4, 5]
  result = nums.reject(fn(x) x > 3 end)
  test.assert_eq(len(result), 3)
  test.assert_eq(result[0], 1)
  test.assert_eq(result[1], 2)
  test.assert_eq(result[2], 3)
end

# ============================================================
# D. each
# ============================================================

# Keep as shell-out: uses `use "conv"` inside the script
rats "array.each iterates with side effects"
  script = <<~SCRIPT
    use "conv"
    total = 0
    nums = [10, 20, 30]
    nums.each(fn(x) total = total end)
    puts(len(nums))
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "3")
end

# ============================================================
# E. reduce
# ============================================================

rats "array.reduce accumulates a result"
  nums = [1, 2, 3, 4, 5]
  sum = nums.reduce(0, fn(acc, x) acc + x end)
  test.assert_eq(sum, 15)
end

rats "array.reduce with string accumulator"
  words = ["hello", "world"]
  result = words.reduce("", fn(acc, w) acc + w + " " end)
  test.assert_eq(result, "hello world ")
end

# ============================================================
# F. find
# ============================================================

rats "array.find returns first matching element"
  nums = [1, 2, 3, 4, 5]
  found = nums.find(fn(x) x > 3 end)
  test.assert_eq(found, 4)
end

rats "array.find returns nil when no match"
  nums = [1, 2, 3]
  found = nums.find(fn(x) x > 10 end)
  test.assert_nil(found)
end

# ============================================================
# G. any / all
# ============================================================

rats "array.any returns true when match exists"
  test.assert_true([1, 2, 3].any(fn(x) x > 2 end))
end

rats "array.any returns false when no match"
  test.assert_false([1, 2, 3].any(fn(x) x > 10 end))
end

rats "array.all returns true when all match"
  test.assert_true([1, 2, 3].all(fn(x) x > 0 end))
end

rats "array.all returns false when one fails"
  test.assert_false([1, 2, 3].all(fn(x) x > 1 end))
end

# ============================================================
# H. count
# ============================================================

rats "array.count counts matching elements"
  nums = [1, 2, 3, 4, 5]
  test.assert_eq(nums.count(fn(x) x > 2 end), 3)
end

# ============================================================
# I. join
# ============================================================

rats "array.join with separator"
  words = ["a", "b", "c"]
  test.assert_eq(words.join(", "), "a, b, c")
end

rats "array.join with empty separator"
  letters = ["x", "y", "z"]
  test.assert_eq(letters.join(""), "xyz")
end

rats "array.join converts non-strings"
  nums = [1, 2, 3]
  test.assert_eq(nums.join("-"), "1-2-3")
end

# ============================================================
# J. first / last
# ============================================================

rats "array.first returns first element"
  test.assert_eq([10, 20, 30].first(), 10)
end

rats "array.last returns last element"
  test.assert_eq([10, 20, 30].last(), 30)
end

rats "array.first on empty returns nil"
  test.assert_nil([].first())
end

# ============================================================
# K. min / max / sum
# ============================================================

rats "array.min returns minimum value"
  test.assert_eq([3, 1, 4, 1, 5].min(), 1)
end

rats "array.max returns maximum value"
  test.assert_eq([3, 1, 4, 1, 5].max(), 5)
end

rats "array.sum returns total"
  test.assert_eq([10, 20, 30].sum(), 60)
end

# ============================================================
# L. flatten / uniq
# ============================================================

# Keep as shell-out: uses `use "conv"` inside the script
rats "array.flatten one level deep"
  script = <<~SCRIPT
    use "conv"
    nested = [[1, 2], [3, 4], 5]
    result = nested.flatten()
    puts(len(result))
    puts(result[0])
    puts(result[4])
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "5")
  test.assert_eq(lines[1], "1")
  test.assert_eq(lines[2], "5")
end

rats "array.uniq removes duplicates preserving order"
  result = [1, 2, 2, 3, 1].uniq()
  test.assert_eq(len(result), 3)
  test.assert_eq(result[0], 1)
  test.assert_eq(result[1], 2)
  test.assert_eq(result[2], 3)
end

# ============================================================
# M. sort_by
# ============================================================

rats "array.sort_by sorts by lambda result"
  fruits = ["banana", "apple", "cherry", "fig"]
  result = fruits.sort_by(fn(s) len(s) end)
  test.assert_eq(result[0], "fig")
  test.assert_eq(result[1], "apple")
  test.assert_eq(result[2], "banana")
  test.assert_eq(result[3], "cherry")
end

rats "array.sort_by does not mutate original"
  nums = [3, 1, 2]
  sorted = nums.sort_by(fn(x) x end)
  test.assert_eq(nums[0], 3)
  test.assert_eq(sorted[0], 1)
end

# ============================================================
# N. flat_map
# ============================================================

rats "array.flat_map maps and flattens"
  result = [1, 2, 3].flat_map(fn(x) [x, x * 10] end)
  test.assert_eq(len(result), 6)
  test.assert_eq(result[0], 1)
  test.assert_eq(result[1], 10)
  test.assert_eq(result[4], 3)
  test.assert_eq(result[5], 30)
end

# ============================================================
# O. take / drop
# ============================================================

rats "array.take returns first n elements"
  result = [1, 2, 3, 4, 5].take(3)
  test.assert_eq(len(result), 3)
  test.assert_eq(result[0], 1)
  test.assert_eq(result[2], 3)
end

rats "array.drop returns all but first n"
  result = [1, 2, 3, 4, 5].drop(3)
  test.assert_eq(len(result), 2)
  test.assert_eq(result[0], 4)
  test.assert_eq(result[1], 5)
end

# ============================================================
# P. zip
# ============================================================

rats "array.zip pairs elements from two arrays"
  a = [1, 2, 3]
  b = ["x", "y", "z"]
  result = a.zip(b)
  test.assert_eq(len(result), 3)
  test.assert_eq(result[0][0], 1)
  test.assert_eq(result[0][1], "x")
  test.assert_eq(result[2][0], 3)
  test.assert_eq(result[2][1], "z")
end

# ============================================================
# Q. chunk
# ============================================================

rats "array.chunk splits into groups"
  result = [1, 2, 3, 4, 5].chunk(2)
  test.assert_eq(len(result), 3)
  test.assert_eq(len(result[0]), 2)
  test.assert_eq(len(result[2]), 1)
  test.assert_eq(result[0][0], 1)
  test.assert_eq(result[2][0], 5)
end

# ============================================================
# R. Chaining
# ============================================================

rats "array method chaining works"
  result = [1, 2, 3, 4, 5].filter(fn(x) x > 2 end).map(fn(x) x * 10 end).join(" + ")
  test.assert_eq(result, "30 + 40 + 50")
end

rats "array map then reduce chain"
  result = [1, 2, 3].map(fn(x) x * x end).reduce(0, fn(acc, x) acc + x end)
  test.assert_eq(result, 14)
end
