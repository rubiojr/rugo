# RATS: Top-level lowercase variables are block-scoped and do NOT leak
# into rats blocks. Only constants (UPPERCASE) are shared across scopes.
# This is by design — it prevents accidental mutation from distant code.
use "test"

rats "top-level variable is NOT visible in rats block"
  script = <<~SCRIPT
    use "test"
    port = 8080
    rats "cannot see port"
      result = try port or "undefined"
      test.assert_eq(result, "undefined")
    end
  SCRIPT
  test.write_file("#{test.tmpdir()}/test_test.rugo", script)
  result = test.run("rugo rats #{test.tmpdir()}/test_test.rugo")
  # Compile error is expected — port is not in scope
  test.assert_neq(result["status"], 0)
end

rats "top-level variable assigned in setup_file stays local"
  script = <<~SCRIPT
    use "test"
    port = 0
    def setup_file()
      port = 8080
    end
    rats "port not visible"
      result = try port or "undefined"
      test.assert_eq(result, "undefined")
    end
  SCRIPT
  test.write_file("#{test.tmpdir()}/test_test.rugo", script)
  result = test.run("rugo rats #{test.tmpdir()}/test_test.rugo")
  # Compile error is expected — port is not in scope
  test.assert_neq(result["status"], 0)
end

rats "top-level constant is NOT visible in rats block either"
  script = <<~SCRIPT
    use "test"
    PORT = 8080
    rats "cannot see PORT"
      result = try PORT or "undefined"
      test.assert_eq(result, "undefined")
    end
  SCRIPT
  test.write_file("#{test.tmpdir()}/test_test.rugo", script)
  result = test.run("rugo rats #{test.tmpdir()}/test_test.rugo")
  # rats blocks are isolated — even constants are not in scope
  test.assert_neq(result["status"], 0)
end

rats "top-level variable visible in def function"
  script = <<~SCRIPT
    port = 9090
    def get_port()
      return port
    end
    puts get_port()
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "9090")
end
