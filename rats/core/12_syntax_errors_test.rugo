# Tests for compile-time and runtime error messages.
# Ensures errors are clear, point to correct lines, and don't false-positive.

use "test"
use "str"
use "eval"

# --- Runtime type errors ---

rats "cannot index-assign to scalar"
  source = <<~RUGO
    x = 42
    x[0] = 5
  RUGO
  result = eval.run(source)
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "cannot index-assign Integer")
end

rats "cannot index scalar"
  source = <<~RUGO
    x = 42
    puts x[0]
  RUGO
  result = eval.run(source)
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "cannot index Integer")
end

rats "cannot subtract strings"
  source = <<~RUGO
    x = "hello" - "world"
  RUGO
  result = eval.run(source)
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "cannot subtract String and String")
end

rats "cannot multiply string by int"
  source = <<~RUGO
    x = "hello" * 3
  RUGO
  result = eval.run(source)
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "cannot multiply String and Integer")
end

rats "cannot add nil and int"
  source = <<~RUGO
    x = nil + 5
  RUGO
  result = eval.run(source)
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "cannot add")
end

rats "integer divide by zero"
  source = <<~RUGO
    x = 5 / 0
  RUGO
  result = eval.run(source)
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "division by zero")
end

rats "integer modulo by zero"
  source = <<~RUGO
    x = 5 % 0
  RUGO
  result = eval.run(source)
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "division by zero")
end

# --- Builtin function errors ---

rats "len with no arguments"
  source = <<~RUGO
    puts len()
  RUGO
  result = eval.run(source)
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "len requires one argument")
end

rats "len on non-indexable type"
  source = <<~RUGO
    puts len(42)
  RUGO
  result = eval.run(source)
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "cannot get length of Integer")
end

rats "append on non-array"
  source = <<~RUGO
    append(42, 5)
  RUGO
  result = eval.run(source)
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "first argument to append must be an array")
end

# --- Compile-time errors ---

rats "unknown stdlib module"
  source = <<~RUGO
    use "nonexistent"
  RUGO
  result = eval.run(source)
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "unknown module")
end

rats "missing end keyword"
  source = <<~RUGO
    if true
      puts "hello"
  RUGO
  result = eval.run(source)
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "error:")
end

rats "mismatched bracket"
  source = <<~RUGO
    x = [1, 2)
  RUGO
  result = eval.run(source)
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "error:")
end

# --- Orphan or detection ---

rats "orphan or without try produces error"
  source = <<~'RUGO'
    somecommand arg1 or "fallback"
  RUGO
  result = eval.run(source)
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "or")
  test.assert_contains(result["output"], "try")
end

rats "or inside string literal is not flagged"
  source = <<~RUGO
    echo "hello or world"
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "hello or world")
end

rats "or as part of a word is not flagged"
  source = <<~RUGO
    echo ordering
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "ordering")
end

# --- Error output format ---

rats "runtime errors have no Go stacktrace"
  source = <<~RUGO
    x = 5 / 0
  RUGO
  result = eval.run(source)
  test.assert_neq(result["status"], 0)
  lines = result["lines"]
  for line in lines
    test.assert_false(str.contains(line, "goroutine"))
    test.assert_false(str.contains(line, "main.go"))
  end
end

rats "runtime errors show .rugo filename and line"
  source = <<~RUGO
    x = 5 / 0
  RUGO
  result = eval.run(source)
  test.assert_contains(result["output"], "eval.rugo:1")
end

# --- Unterminated literals ---

rats "unclosed backtick produces clear error"
  source = <<~'RUGO'
    x = `echo hello
    puts x
  RUGO
  result = eval.run(source)
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "unterminated backtick")
end

rats "unclosed string produces clear error"
  source = <<~'RUGO'
    x = "hello
    puts x
  RUGO
  result = eval.run(source)
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "unterminated string")
end
