# RATS: Test json module (parse, encode)
use "test"
use "conv"
use "json"

rats "json.parse parses object"
  data = json.parse("{\"name\": \"rugo\", \"version\": 1}")
  test.assert_eq(data["name"], "rugo")
  test.assert_eq(conv.to_s(data["version"]), "1")
end

rats "json.parse parses array"
  arr = json.parse("[1, 2, 3]")
  test.assert_eq(len(arr), 3)
  test.assert_eq(conv.to_s(arr[0]), "1")
  test.assert_eq(conv.to_s(arr[2]), "3")
end

rats "json.parse converts whole numbers to int"
  data = json.parse("{\"id\": 12345}")
  test.assert_eq(conv.to_s(data["id"]), "12345")
end

rats "json.parse preserves floats"
  data = json.parse("{\"pi\": 3.14}")
  test.assert_eq(conv.to_s(data["pi"]), "3.14")
end

rats "json.parse handles nested objects"
  data = json.parse("{\"user\": {\"name\": \"rugo\"}}")
  test.assert_eq(data["user"]["name"], "rugo")
end

rats "json.parse handles booleans and null"
  data = json.parse("{\"ok\": true, \"err\": null}")
  test.assert_eq(conv.to_s(data["ok"]), "true")
  test.assert_eq(data["err"] == nil, true)
end

rats "json.encode converts hash to JSON"
  h = {"a" => 1}
  result = json.encode(h)
  test.assert_contains(result, "\"a\"")
  test.assert_contains(result, "1")
end

rats "json.encode converts array to JSON"
  arr = [1, "two", true]
  test.assert_eq(json.encode(arr), "[1,\"two\",true]")
end

rats "json.parse roundtrip"
  original = "[1,2,3]"
  parsed = json.parse(original)
  result = json.encode(parsed)
  test.assert_eq(result, "[1,2,3]")
end

rats "json.parse panics on invalid JSON"
  script = <<~SCRIPT
    use "json"
    json.parse("not json")
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "json.parse")
end
