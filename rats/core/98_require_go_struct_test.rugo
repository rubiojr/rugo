# RATS: Test Go module struct support
# require can load Go modules with exported structs and bridge them
use "test"
use "conv"
use "str"

rats "struct zero-value constructor and field set/get"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    c = sm.config()
    c.name = "myapp"
    c.port = 8080
    puts(c.name)
    puts(c.port)
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "myapp")
  test.assert_eq(lines[1], "8080")
end

rats "struct new_config constructor with args"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    c = sm.new_config("app", 3000)
    puts(c.name)
    puts(c.port)
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "app")
  test.assert_eq(lines[1], "3000")
end

rats "struct passed to Go function taking *Struct"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    c = sm.new_config("test", 9090)
    puts(sm.get_name(c))
    puts(sm.get_port(c))
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "test")
  test.assert_eq(lines[1], "9090")
end

rats "struct returned from Go function is wrapped"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    c = sm.new_config("orig", 80)
    c2 = sm.set_name(c, "updated")
    puts(c2.name)
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "updated")
end

rats "struct field modification via dot assign"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    c = sm.config()
    c.name = "before"
    c.name = "after"
    puts(c.name)
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "after")
end

rats "struct __type__ returns struct name"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    c = sm.config()
    puts(type_of(c))
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "Config")
end

rats "struct multiple types in same package"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    s = sm.new_server("localhost", 443)
    puts(sm.server_host(s))
    puts(sm.is_debug(s))
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "localhost")
  test.assert_eq(lines[1], "false")
end

rats "struct bool and float fields"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    s = sm.server()
    s.debug = true
    s.timeout = 30.5
    puts(s.debug)
    puts(s.timeout)
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "true")
  test.assert_eq(lines[1], "30.5")
end

rats "plain functions still work alongside structs"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    puts(sm.greet("world"))
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "Hello, world!")
end

rats "struct describe function uses struct fields"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    c = sm.new_config("production", 443)
    puts(sm.describe(c))
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "production config")
end

# --- Method tests ---

rats "method returning string"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    c = sm.new_config("myapp", 8080)
    puts(c.summary())
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "myapp config")
end

rats "void method mutates struct"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    c = sm.new_config("app", 80)
    c.set_port(9090)
    puts(c.port)
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "9090")
end

rats "method returning struct pointer"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    c = sm.new_config("orig", 80)
    c2 = c.clone()
    c2.name = "copy"
    puts(c.name)
    puts(c2.name)
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "orig")
  test.assert_eq(lines[1], "copy")
end

rats "method with bool param"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    s = sm.new_server("host", 443)
    s.set_debug(true)
    puts(s.debug)
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "true")
end

rats "opaque struct methods (no exported fields)"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    c = sm.new_counter()
    c.inc()
    c.inc()
    c.add(3)
    puts(c.value())
    c.reset()
    puts(c.value())
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "5")
  test.assert_eq(lines[1], "0")
end

rats "opaque struct type_of"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    c = sm.new_counter()
    puts(type_of(c))
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "Counter")
end

rats "rugo doc shows struct methods"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  result = test.run("NO_COLOR=1 rugo doc #{tmpdir}/go_module_struct")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], ".summary() -> string")
  test.assert_contains(result["output"], ".set_port(int)")
  test.assert_contains(result["output"], ".clone() -> Config")
  test.assert_contains(result["output"], "struct Counter {}")
  test.assert_contains(result["output"], ".inc()")
  test.assert_contains(result["output"], ".value() -> int")
end

# --- Error message tests ---

rats "undefined method error shows struct name not Go type"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    c = sm.new_counter()
    c.nope()
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "undefined method .nope() on Counter")
  test.assert_false(str.contains(result["output"], "rugo_struct"))
end

rats "undefined field error shows struct name not Go type"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    c = sm.new_counter()
    puts(c.nope)
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "Counter")
  test.assert_false(str.contains(result["output"], "rugo_struct"))
end

rats "PascalCase method call gives clean error"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    c = sm.new_counter()
    c.Add(1)
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "undefined method .Add() on Counter")
end

rats "set field on opaque struct gives clean error"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    c = sm.new_counter()
    c.count = 5
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "Counter")
  test.assert_false(str.contains(result["output"], "rugo_struct"))
end

rats "method on struct with fields works alongside field access"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    c = sm.new_config("app", 80)
    puts(c.name)
    puts(c.summary())
    c.set_port(9090)
    puts(c.port)
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  result = test.run("rugo run #{tmpdir}/main.rugo")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "app")
  test.assert_eq(lines[1], "app config")
  test.assert_eq(lines[2], "9090")
end

rats "struct build produces working binary"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/go_module_struct #{tmpdir}/go_module_struct")
  script = <<~SCRIPT
    require "go_module_struct" as sm
    c = sm.new_counter()
    c.add(10)
    puts(c.value())
    cfg = sm.new_config("prod", 443)
    puts(cfg.summary())
  SCRIPT
  test.write_file("#{tmpdir}/main.rugo", script)
  build_result = test.run("rugo build #{tmpdir}/main.rugo -o #{tmpdir}/main_bin")
  test.assert_eq(build_result["status"], 0)
  result = test.run("#{tmpdir}/main_bin")
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "10")
  test.assert_eq(lines[1], "prod config")
end
