# RATS: Bare append sugar â€” append arr, val â†’ arr = append(arr, val)
use "test"
use "eval"

rats "bare append basic paren-free"
  arr = [1, 2]
  append arr, 3
  test.assert_eq(len(arr), 3)
  test.assert_eq(arr[2], 3)
end

rats "bare append with explicit parens"
  arr = [1, 2]
  append(arr, 3)
  test.assert_eq(len(arr), 3)
  test.assert_eq(arr[2], 3)
end

rats "bare append mixed parens and paren-free"
  source = <<~RUGO
    # Both paren-free and explicit parens should work
    arr = []
    append arr, 1
    append(arr, 2)
    append arr, 3
    append(arr, 4)

    puts arr[0]
    puts arr[1]
    puts arr[2]
    puts arr[3]
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "1")
  test.assert_eq(lines[1], "2")
  test.assert_eq(lines[2], "3")
  test.assert_eq(lines[3], "4")
end

rats "bare append backward compat explicit assign"
  source = <<~RUGO
    # Backward compat: explicit assign should still work
    arr = [1, 2]
    arr = append(arr, 3)
    puts len(arr)
    puts arr[2]
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "3")
  test.assert_eq(lines[1], "3")
end

rats "bare append inside def"
  source = <<~RUGO
    def collect(items)
      result = []
      for item in items
        append result, item * 2
      end
      return result
    end

    nums = collect([1, 2, 3])
    puts nums[0]
    puts nums[1]
    puts nums[2]
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "2")
  test.assert_eq(lines[1], "4")
  test.assert_eq(lines[2], "6")
end

rats "bare append inside lambda"
  source = <<~RUGO
    arr = []
    adder = fn(x)
      append arr, x
    end

    adder(10)
    adder(20)
    adder(30)
    puts arr[0]
    puts arr[1]
    puts arr[2]
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "10")
  test.assert_eq(lines[1], "20")
  test.assert_eq(lines[2], "30")
end

rats "bare append inside for loop"
  arr = []
  for i in [10, 20, 30]
    append arr, i
  end
  test.assert_eq(arr[0], 10)
  test.assert_eq(arr[1], 20)
  test.assert_eq(arr[2], 30)
end

rats "bare append inside while loop"
  source = <<~RUGO
    arr = []
    i = 0
    while i < 3
      append arr, i * 10
      i += 1
    end
    puts arr[0]
    puts arr[1]
    puts arr[2]
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "0")
  test.assert_eq(lines[1], "10")
  test.assert_eq(lines[2], "20")
end

rats "bare append inside if/elsif/else"
  source = <<~RUGO
    arr = []
    x = 5

    if x > 3
      append arr, "big"
    elsif x > 1
      append arr, "medium"
    else
      append arr, "small"
    end

    if x < 2
      append arr, "low"
    else
      append arr, "high"
    end

    puts arr[0]
    puts arr[1]
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "big")
  test.assert_eq(lines[1], "high")
end

rats "bare append with try/or"
  source = <<~RUGO
    arr = []

    result = try
      "ok"
    or err
      "fail"
    end
    append arr, result

    result2 = try
      raise "boom"
    or err
      "caught"
    end
    append arr, result2

    puts arr[0]
    puts arr[1]
    puts len(arr)
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "ok")
  test.assert_eq(lines[1], "caught")
  test.assert_eq(lines[2], "2")
end

rats "bare append inside spawn"
  source = <<~RUGO
    use "conv"

    tasks = []
    for i in [1, 2, 3]
      t = spawn
        conv.to_s(i * 10)
      end
      append tasks, t
    end

    for t in tasks
      puts t.value
    end
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "10")
  test.assert_eq(lines[1], "20")
  test.assert_eq(lines[2], "30")
end

rats "bare append nested for inside def"
  source = <<~RUGO
    def build_matrix(rows, cols)
      matrix = []
      for r in rows
        row = []
        for c in cols
          append row, r * c
        end
        append matrix, row
      end
      return matrix
    end

    m = build_matrix([1, 2, 3], [10, 20])
    puts m[0][0]
    puts m[0][1]
    puts m[1][0]
    puts m[1][1]
    puts m[2][0]
    puts m[2][1]
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "10")
  test.assert_eq(lines[1], "20")
  test.assert_eq(lines[2], "20")
  test.assert_eq(lines[3], "40")
  test.assert_eq(lines[4], "30")
  test.assert_eq(lines[5], "60")
end

rats "bare append to multiple arrays"
  source = <<~RUGO
    evens = []
    odds = []

    for i in [1, 2, 3, 4, 5, 6]
      if i % 2 == 0
        append evens, i
      else
        append odds, i
      end
    end

    puts len(evens)
    puts len(odds)
    puts evens[0]
    puts evens[1]
    puts evens[2]
    puts odds[0]
    puts odds[1]
    puts odds[2]
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "3")
  test.assert_eq(lines[1], "3")
  test.assert_eq(lines[2], "2")
  test.assert_eq(lines[3], "4")
  test.assert_eq(lines[4], "6")
  test.assert_eq(lines[5], "1")
  test.assert_eq(lines[6], "3")
  test.assert_eq(lines[7], "5")
end

rats "bare append with expression values"
  source = <<~RUGO
    arr = []

    # Append with arithmetic expression
    append arr, 2 + 3

    # Append with string concatenation
    append arr, "hello" + " world"

    # Append with function call as value
    append arr, len([1, 2, 3])

    puts arr[0]
    puts arr[1]
    puts arr[2]
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "5")
  test.assert_eq(lines[1], "hello world")
  test.assert_eq(lines[2], "3")
end

rats "bare append preserves insertion order"
  source = <<~RUGO
    arr = []
    append arr, "first"
    append arr, "second"
    append arr, "third"
    append arr, "fourth"
    append arr, "fifth"

    for item in arr
      puts item
    end
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "first")
  test.assert_eq(lines[1], "second")
  test.assert_eq(lines[2], "third")
  test.assert_eq(lines[3], "fourth")
  test.assert_eq(lines[4], "fifth")
end

rats "bare append with struct constructor"
  source = <<~RUGO
    struct Item
      name
    end

    def build_items(names)
      items = []
      for n in names
        append items, Item(n)
      end
      return items
    end

    result = build_items(["apple", "banana", "cherry"])
    puts result[0]["name"]
    puts result[1]["name"]
    puts result[2]["name"]
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "apple")
  test.assert_eq(lines[1], "banana")
  test.assert_eq(lines[2], "cherry")
end

rats "bare append non-array still errors"
  source = <<~RUGO
    append(42, 5)
  RUGO
  result = eval.run(source)
  test.assert_neq(result["status"], 0)
end

rats "bare append inside def with lambda"
  source = <<~RUGO
    def process(items)
      mapper = fn(x) x + 1 end
      result = []
      for item in items
        append result, mapper(item)
      end
      return result
    end
    arr = process([10, 20, 30])
    puts(arr[0])
    puts(arr[1])
    puts(arr[2])
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "11")
  test.assert_eq(lines[1], "21")
  test.assert_eq(lines[2], "31")
end

rats "bare append with string interpolation"
  arr = []
  name = "world"
  append arr, "hello #{name}"
  test.assert_eq(arr[0], "hello world")
end

rats "bare append with hash value"
  arr = []
  append arr, {"key" => "val"}
  test.assert_eq(arr[0]["key"], "val")
end

rats "bare append with nil value"
  arr = []
  append arr, nil
  test.assert_eq(len(arr), 1)
  test.assert_eq(arr[0] == nil, true)
end

rats "bare append with boolean values"
  arr = []
  append arr, true
  append arr, false
  test.assert_eq(arr[0], true)
  test.assert_eq(arr[1], false)
end

rats "bare append deeply nested blocks"
  source = <<~RUGO
    def process(items)
      result = []
      for item in items
        if item > 0
          i = 0
          while i < item
            append result, i
            i += 1
          end
        end
      end
      return result
    end
    arr = process([2, 3])
    puts(len(arr))
    puts(arr[0])
    puts(arr[1])
    puts(arr[2])
    puts(arr[3])
    puts(arr[4])
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  lines = result["lines"]
  test.assert_eq(lines[0], "5")
  test.assert_eq(lines[1], "0")
  test.assert_eq(lines[2], "1")
  test.assert_eq(lines[3], "0")
  test.assert_eq(lines[4], "1")
  test.assert_eq(lines[5], "2")
end
