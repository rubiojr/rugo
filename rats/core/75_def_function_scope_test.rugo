# RATS: Test that def functions can access top-level variables
use "test"
use "eval"

rats "def function can access top-level constant"
  source = <<~RUGO
    GREETING = "hello"
    def greet()
      return GREETING
    end
    puts greet()
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "hello")
end

rats "def function can access top-level variable"
  source = <<~RUGO
    count = 42
    def get_count()
      return count
    end
    puts get_count()
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "42")
end

rats "def function can access top-level hash"
  source = <<~RUGO
    config = {greeting: "hello"}
    def get_greeting()
      return config["greeting"]
    end
    puts get_greeting()
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "hello")
end

rats "def function can access top-level array"
  source = <<~RUGO
    items = [1, 2, 3]
    def first_item()
      return items[0]
    end
    puts first_item()
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "1")
end

rats "def function with params still works alongside top-level vars"
  source = <<~RUGO
    PREFIX = "Hello"
    def greet(name)
      return PREFIX + ", " + name + "!"
    end
    puts greet("world")
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "Hello, world!")
end

rats "local assignment shadows top-level var (no promotion)"
  source = <<~RUGO
    name = "top"
    def shadow()
      name = "local"
      return name
    end
    puts shadow()
    puts name
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["lines"][0], "local")
  test.assert_eq(result["lines"][1], "top")
end

rats "multiple functions share same promoted var"
  source = <<~RUGO
    BASE = "/api"
    def route_a()
      return BASE + "/a"
    end
    def route_b()
      return BASE + "/b"
    end
    puts route_a()
    puts route_b()
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["lines"][0], "/api/a")
  test.assert_eq(result["lines"][1], "/api/b")
end

rats "promoted var used in condition inside def"
  source = <<~RUGO
    LIMIT = 10
    def check(n)
      if n > LIMIT
        return "over"
      end
      return "under"
    end
    puts check(5)
    puts check(15)
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["lines"][0], "under")
  test.assert_eq(result["lines"][1], "over")
end

rats "promoted var used in loop inside def"
  source = <<~RUGO
    items = ["a", "b", "c"]
    def joined()
      result = ""
      for _, v in items
        result = result + v
      end
      return result
    end
    puts joined()
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "abc")
end

rats "function without top-level refs still works"
  source = <<~RUGO
    UNUSED = "never read"
    def add(a, b)
      return a + b
    end
    puts add(3, 4)
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "7")
end

rats "assigning top-level var inside def creates local shadow"
  source = <<~RUGO
    counter = 0
    def bump()
      counter = 99
      return counter
    end
    puts bump()
    puts counter
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["lines"][0], "99")
  test.assert_eq(result["lines"][1], "0")
end
