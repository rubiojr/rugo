# RATS: Test require with directory-as-module (local entry point resolution)
# require "dir" resolves to dir/<dirname>.rg, dir/main.rg, or the sole .rugo file
use "test"

rats "require directory resolves <dirname>.rugo entry point"
  result = test.run("rugo run rats/fixtures/dir_entry_basic.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "hello from dir_entry_lib, world")
end

rats "require directory resolves main.rugo fallback"
  result = test.run("rugo run rats/fixtures/dir_entry_main_test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "hi from main.rugo")
end

rats "require directory with alias works"
  result = test.run("rugo run rats/fixtures/dir_entry_alias.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "hello from dir_entry_lib, alias")
end

rats "require directory resolves sole .rugo file"
  tmpdir = test.tmpdir()
  test.run("mkdir -p " + tmpdir + "/mymod")
  test.write_file(tmpdir + "/mymod/utils.rugo", "def ping()\n  return \"pong\"\nend\n")
  script = <<~SCRIPT
    require "mymod"
    puts(mymod.ping())
  SCRIPT
  test.write_file(tmpdir + "/main.rugo", script)
  result = test.run("rugo run " + tmpdir + "/main.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "pong")
end

rats "require directory works with rugo build"
  tmpdir = test.tmpdir()
  test.run("cp -r rats/fixtures/dir_entry_lib " + tmpdir + "/dir_entry_lib")
  script = <<~SCRIPT
    require "dir_entry_lib"
    puts(dir_entry_lib.greet("binary"))
  SCRIPT
  test.write_file(tmpdir + "/main.rugo", script)
  build_result = test.run("rugo build " + tmpdir + "/main.rugo -o " + tmpdir + "/main_bin")
  test.assert_eq(build_result["status"], 0)
  result = test.run(tmpdir + "/main_bin")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "hello from dir_entry_lib, binary")
end

# --- Negative tests ---

rats "require directory fails when ambiguous (multiple .rugo files, no entry point)"
  tmpdir = test.tmpdir()
  test.run("mkdir -p " + tmpdir + "/ambiguous")
  test.write_file(tmpdir + "/ambiguous/foo.rugo", "def foo()\n  return 1\nend\n")
  test.write_file(tmpdir + "/ambiguous/bar.rugo", "def bar()\n  return 2\nend\n")
  script = <<~SCRIPT
    require "ambiguous"
  SCRIPT
  test.write_file(tmpdir + "/main.rugo", script)
  result = test.run("rugo run " + tmpdir + "/main.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "cannot determine entry point")
  test.assert_contains(result["output"], "with")
end

rats "require directory fails when no Rugo source files"
  tmpdir = test.tmpdir()
  test.run("mkdir -p " + tmpdir + "/empty_dir")
  script = <<~SCRIPT
    require "empty_dir"
  SCRIPT
  test.write_file(tmpdir + "/main.rugo", script)
  result = test.run("rugo run " + tmpdir + "/main.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "no Rugo source files")
end

rats "require prefers file over directory when both exist"
  tmpdir = test.tmpdir()
  test.run("mkdir -p " + tmpdir + "/mymod")
  test.write_file(tmpdir + "/mymod.rugo", "def source()\n  return \"file\"\nend\n")
  test.write_file(tmpdir + "/mymod/mymod.rugo", "def source()\n  return \"dir\"\nend\n")
  script = <<~SCRIPT
    require "mymod"
    puts(mymod.source())
  SCRIPT
  test.write_file(tmpdir + "/main.rugo", script)
  result = test.run("rugo run " + tmpdir + "/main.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "file")
end
