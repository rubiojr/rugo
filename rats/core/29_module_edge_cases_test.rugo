# RATS: Module import/require edge cases
use "test"
use "str"

# Bug 186d619: require alias matching stdlib name without import should use user module
rats "require alias with stdlib name calls user module"
  test.run("mkdir -p " + test.tmpdir() + "/t1")
  helpers = <<~HELPERS
    def upper(s)
      return "CUSTOM: " + s
    end
  HELPERS
  test.write_file(test.tmpdir() + "/t1/helpers.rugo", helpers)
  main = <<~MAIN
    require "helpers" as "str"
    puts(str.upper("hello"))
  MAIN
  test.write_file(test.tmpdir() + "/t1/main.rugo", main)
  result = test.run("rugo run " + test.tmpdir() + "/t1/main.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "CUSTOM: hello")
end

# Bug 65f41d8: require alias conflicting with imported module should error
rats "require alias conflicts with imported module"
  test.run("mkdir -p " + test.tmpdir() + "/t2")
  helpers = <<~HELPERS
    def upper(s)
      return "CUSTOM"
    end
  HELPERS
  test.write_file(test.tmpdir() + "/t2/helpers.rugo", helpers)
  main = <<~MAIN
    use "str"
    require "helpers" as "str"
  MAIN
  test.write_file(test.tmpdir() + "/t2/main.rugo", main)
  result = test.run("rugo run " + test.tmpdir() + "/t2/main.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "str")
end

# Bug 6013a24: imports inside required files should propagate
rats "required file imports propagate"
  test.run("mkdir -p " + test.tmpdir() + "/t3")
  helpers = <<~HELPERS
    use "conv"
    def double_str(n)
      return conv.to_s(n * 2)
    end
  HELPERS
  test.write_file(test.tmpdir() + "/t3/helpers.rugo", helpers)
  main = <<~MAIN
    require "helpers"
    puts(helpers.double_str(21))
  MAIN
  test.write_file(test.tmpdir() + "/t3/main.rugo", main)
  result = test.run("rugo run " + test.tmpdir() + "/t3/main.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "42")
end

# Bug 51ab700: import inside function body should error
rats "import inside function body errors"
  script = <<~SCRIPT
    def foo()
      use "conv"
    end
  SCRIPT
  test.write_file(test.tmpdir() + "/nested_import.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/nested_import.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "top level")
end

# Bug 51ab700: require inside function body should error
rats "require inside function body errors"
  test.run("mkdir -p " + test.tmpdir() + "/t5")
  helpers = <<~HELPERS
    def foo()
      return 1
    end
  HELPERS
  test.write_file(test.tmpdir() + "/t5/helpers.rugo", helpers)
  main = <<~MAIN
    def bar()
      require "helpers"
    end
  MAIN
  test.write_file(test.tmpdir() + "/t5/main.rugo", main)
  result = test.run("rugo run " + test.tmpdir() + "/t5/main.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "top level")
end

# Bug 59e1dc8: two requires same alias with conflicting function names
rats "duplicate namespace function errors"
  test.run("mkdir -p " + test.tmpdir() + "/t6")
  a = <<~A
    def foo()
      return "a"
    end
  A
  test.write_file(test.tmpdir() + "/t6/a.rugo", a)
  b = <<~B
    def foo()
      return "b"
    end
  B
  test.write_file(test.tmpdir() + "/t6/b.rugo", b)
  main = <<~MAIN
    require "a" as "ns"
    require "b" as "ns"
    puts(ns.foo())
  MAIN
  test.write_file(test.tmpdir() + "/t6/main.rugo", main)
  result = test.run("rugo run " + test.tmpdir() + "/t6/main.rugo")
  test.assert_neq(result["status"], 0)
  test.assert_contains(result["output"], "foo")
end

# Bug 6ee382f: duplicate import is silently deduplicated
rats "duplicate import is deduplicated"
  script = <<~SCRIPT
    use "conv"
    use "conv"
    puts(conv.to_s(42))
  SCRIPT
  test.write_file(test.tmpdir() + "/dup_import.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/dup_import.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "42")
end

# Cross-file import deduplication: main and helper both import the same stdlib module
rats "shared stdlib import across main and required file"
  test.run("mkdir -p " + test.tmpdir() + "/t7")
  helpers = <<~HELPERS
    use "conv"
    def to_int(s)
      return conv.to_i(s)
    end
  HELPERS
  test.write_file(test.tmpdir() + "/t7/helpers.rugo", helpers)
  main = <<~MAIN
    use "conv"
    require "helpers"
    x = helpers.to_int("10")
    puts(conv.to_s(x + 5))
  MAIN
  test.write_file(test.tmpdir() + "/t7/main.rugo", main)
  result = test.run("rugo run " + test.tmpdir() + "/t7/main.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "15")
end
