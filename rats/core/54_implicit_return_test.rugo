# RATS: Test implicit return (last expression in function body)
use "test"

rats "implicit return with literal"
  script = <<~SCRIPT
    def answer
      42
    end
    puts(answer())
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "42")
end

rats "implicit return with variable"
  script = <<~SCRIPT
    def greet(name)
      msg = "hello " + name
      msg
    end
    puts(greet("world"))
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "hello world")
end

rats "implicit return with array index"
  script = <<~SCRIPT
    def last(arr)
      arr[-1]
    end
    puts(last([1, 2, 3]))
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "3")
end

rats "implicit return with function call"
  script = <<~SCRIPT
    use "str"
    def first_word(s)
      parts = str.split(s, " ")
      parts[0]
    end
    puts(first_word("hello world"))
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "hello")
end

rats "implicit return with arithmetic"
  script = <<~SCRIPT
    def double(x)
      x * 2
    end
    puts(double(21))
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "42")
end

rats "explicit return still works"
  script = <<~SCRIPT
    def early(x)
      if x > 10
        return "big"
      end
      "small"
    end
    puts(early(5))
    puts(early(20))
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "small\nbig")
end
