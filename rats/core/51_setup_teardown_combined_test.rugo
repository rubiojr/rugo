# RATS: Test setup_file combined with per-test setup/teardown
use "test"
use "os"
use "conv"
import "os" as go_os

TEST_TMPDIR = `mktemp -d -t rats-combined-XXXXXXXX`

def base_dir()
  return TEST_TMPDIR
end

def setup_file()
  test.write_file("#{TEST_TMPDIR}/counter.txt", "0")
end

def setup()
  bd = base_dir()
  result = test.run("cat #{bd}/counter.txt")
  count = conv.to_i(result["output"]) + 1
  test.write_file("#{bd}/counter.txt", conv.to_s(count))
end

def teardown()
  result = test.run("cat #{base_dir()}/counter.txt")
  test.assert_neq(result["output"], "")
end

def teardown_file()
  go_os.remove_all(TEST_TMPDIR)
end

rats "first test sees counter at 1"
  result = test.run("cat #{base_dir()}/counter.txt")
  test.assert_eq(result["output"], "1")
end

rats "second test sees counter at 2"
  result = test.run("cat #{base_dir()}/counter.txt")
  test.assert_eq(result["output"], "2")
end

rats "third test sees counter at 3"
  result = test.run("cat #{base_dir()}/counter.txt")
  test.assert_eq(result["output"], "3")
end
