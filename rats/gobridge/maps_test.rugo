# RATS: Test Go bridge â€” maps package
use "test"

rats "maps.keys"
  script = <<~SCRIPT
    import "maps"
    use "conv"
    h = {name: "Rugo", version: "1.0", lang: "go"}
    keys = maps.keys(h)
    puts conv.to_s(len(keys))
    puts keys[0]
    puts keys[1]
    puts keys[2]
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "3")
  test.assert_contains(result["output"], "lang")
  test.assert_contains(result["output"], "name")
  test.assert_contains(result["output"], "version")
end

rats "maps.values"
  script = <<~SCRIPT
    import "maps"
    use "conv"
    h = {a: "one", b: "two"}
    vals = maps.values(h)
    puts conv.to_s(len(vals))
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "2")
end

rats "maps.clone"
  script = <<~SCRIPT
    import "maps"
    h = {name: "Rugo", version: "1.0"}
    copy = maps.clone(h)
    copy.name = "Rugo2"
    puts h.name
    puts copy.name
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "Rugo")
  test.assert_contains(result["output"], "Rugo2")
end

rats "maps.equal identical"
  script = <<~SCRIPT
    import "maps"
    puts maps.equal({a: 1, b: 2}, {a: 1, b: 2})
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "true")
end

rats "maps.equal different values"
  script = <<~SCRIPT
    import "maps"
    puts maps.equal({a: 1}, {a: 2})
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "false")
end

rats "maps.equal different keys"
  script = <<~SCRIPT
    import "maps"
    puts maps.equal({a: 1}, {b: 1})
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "false")
end

rats "maps.equal different sizes"
  script = <<~SCRIPT
    import "maps"
    puts maps.equal({a: 1, b: 2}, {a: 1})
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "false")
end

rats "maps empty hash"
  script = <<~SCRIPT
    import "maps"
    use "conv"
    keys = maps.keys({})
    puts conv.to_s(len(keys))
    puts maps.equal({}, {})
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "0")
  test.assert_contains(result["output"], "true")
end

rats "maps.clone is shallow"
  script = <<~SCRIPT
    import "maps"
    h = {data: {inner: "hello"}}
    copy = maps.clone(h)
    copy.data.inner = "world"
    puts h.data.inner
  SCRIPT
  test.write_file(test.tmpdir() + "/test.rugo", script)
  result = test.run("rugo run " + test.tmpdir() + "/test.rugo")
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "world")
end
