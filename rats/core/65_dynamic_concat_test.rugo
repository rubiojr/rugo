# RATS: Test string concat with dynamic variables
# Regression: codegen emitted raw Go + for interface{} variables
use "test"
use "eval"

rats "string concat with reassigned variable in if block"
  arr = ["a", "b"]
  base = "start"
  if len(arr) > 0
    base = base + ", " + arr[0]
  end
  test.assert_eq(base, "start, a")
end

rats "string concat in loop with dynamic source"
  items = ["x", "y", "z"]
  result = ""
  for item in items
    if result != ""
      result = result + ", "
    end
    result = result + item
  end
  test.assert_eq(result, "x, y, z")
end

rats "int arithmetic with reassigned variable in if block"
  arr = [10, 20]
  total = 0
  if len(arr) > 0
    total = total + arr[0]
  end
  test.assert_eq(total, 10)
end

rats "compound concat in function with dynamic variable"
  source = <<~RUGO
    def build(parts)
      s = "SELECT "
      s = s + parts[0]
      if len(parts) > 1
        s = s + ", " + parts[1]
      end
      return s
    end
    puts(build(["a", "b"]))
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_eq(result["output"], "SELECT a, b")
end
