# RATS: Test Go bridge â€” net/url package (1:1 mapping)
use "test"
use "eval"

import "net/url"

rats "url.query_escape and query_unescape"
  escaped = url.query_escape("hello world&foo=bar")
  test.assert_contains(escaped, "hello+world")
  test.assert_eq(url.query_unescape(escaped), "hello world&foo=bar")
end

rats "url.path_escape and path_unescape"
  escaped = url.path_escape("my/path segment")
  test.assert_eq(escaped, "my%2Fpath%20segment")
  test.assert_eq(url.path_unescape(escaped), "my/path segment")
end

# Subprocess: tests exit code on unhandled error
rats "url.query_unescape error"
  script = <<~SCRIPT
    import "net/url"
    url.query_unescape("%ZZ")
  SCRIPT
  test.write_file("#{test.tmpdir()}/test.rugo", script)
  result = test.run("rugo run #{test.tmpdir()}/test.rugo")
  test.assert_eq(result["status"], 1)
end

rats "url with alias"
  source = <<~RUGO
    import "net/url" as u
    puts u.query_escape("hello world")
  RUGO
  result = eval.run(source)
  test.assert_eq(result["status"], 0)
  test.assert_contains(result["output"], "hello+world")
end

rats "url.join_path with single arg"
  result = url.join_path("https://example.com/path")
  test.assert_eq(result, "https://example.com/path")
end

rats "url.join_path with two args"
  result = url.join_path("https://example.com", "api")
  test.assert_eq(result, "https://example.com/api")
end

rats "url.join_path with multiple args"
  result = url.join_path("https://example.com", "api", "v1", "users")
  test.assert_eq(result, "https://example.com/api/v1/users")
end

rats "url.join_path error handling"
  result = try url.join_path("://invalid", "path") or "error"
  test.assert_eq(result, "error")
end
